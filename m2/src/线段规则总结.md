# 原则

**不做回头计算**

TODO:
  **忘记破坏分型规则了**

## 线段规则

线段是通用规则+特殊情况处理相结合

1. 第二特征包含了第一特征和第三特征，触发了79课的特例
2. 80-83点那个也是特殊规则

通用规则是第一特征序列采用前包含一直计算到第二特征序列，第二特征需要采用前后都包含规则

## 特征序列计算

伪代码
    let prev = 前一特征序列
    let current = 本特征序列
    没有包含关系
        返回current
    if 前包含
        设置前包含标志
        包含处理
    if 后包含
        是第二特征序列吗？
            是，设置包含关系标志，这个是为了应对特殊情况处理的
            包含处理
    返回包含处理结果

## 线段判别算法

伪代码

1. 先找到第一个标准线段，设置方向
2. 以每一笔的产生结束来进行迭代
3. 迭代{
    有post_task标志
        设置需要检测第二特征序列，因为设置post_task是第二序列有缺口才设置的。
        因此这个时候，有分型，有缺口
            设置需要检测第二特征序列，清除第二特征序列缓冲队列

    if 这一笔方向与线段方向不同，那这一笔就是特征序列的笔
        计算特征序列，只执行前包含策略，计算结果push缓冲队列
        检测队列中特征序列是否构成分型（最后3个窗口）
        构成分型
            if 有缺口
                设置需要检测第二特征序列，清除第二特征序列缓冲队列
            else 无缺口
                前面一个线段结束，Event=New(分型所在笔的终点)，
                清除缓冲队列，改变线段方向，
                清理Points数组到新起点
                **从分型所在笔为起点，重新计算新方向上的第一特征序列**（这里的第一特征序列肯定不构成分型，因为输入的笔数不够，所以可以放心返回，等待下一笔）
                返回Event
        返回None
    else 这一笔方向与线段方向相同，且需要检测第二特征序列
        计算特征序列，使用前包含+后包含规则，计算结果push第二缓冲队列
        检测队列中分型序列特征是否构成分型
        构成分型
            无缺口
                确认前面两个线段的结束，Event=New2(第一序列分型，第二序列分型)
                清除第一、第二缓冲队列和需要检测第二序列标志，设定线段方向（其实不用变）
                清理Points数组到新起点
                **从起点开始，重新计算新方向上的第一特征序列**（这里的第一特征序列肯定不构成分型，因为输入的笔数不够，所以可以放心返回，等待下一笔）
                返回Event
            有缺口
                确认第一序列的线段结束，Event=New(分型所在笔的终点)，
                清除缓冲队列，改变线段方向，
                清理Points数组到新起点
                **从分型所在笔为起点，重新计算新方向上的特征序列**？？？
                **需要标准化线段**
                这里才是真正的毛病所在，这里输入的笔数足够，可以构成分型，需要重入本程序，这不能接受，
                **这里的处理方式：需要先标准化线段之后，才能计算第一特征序列**
                思考：这里一定产生了分型，因此需要设置一个标志，便于在下一个循环里处理，这个标志位post_task
                返回Event
    None
}

4. 破坏的检查

5. 标准线段问题
    **必须现有标准线段，才有特征序列，所以要先处理成标准线段**
    这里的第一个标准线段是指，任何一个线段端点开始，必须先找到一个标准线段，然后才能有特征序列，然后才能有标准特征序列

6. 第一个线段的检测
    从第一笔的开始，先标准化线段，如果标准化处理完成前，新的笔破坏了第一笔的from端点，以新的高低点为新起点，迭代

7. 线段标准化

8. 潜在分界点的特征
   8.1 如果K2完全包含K1，那么K2就是潜在的分界点
   8.2 如果形成分型，K2就是潜在的分界点

9. 特征序列之间的关系
    9.1 特征序列包含关系判断，不包含，前包含，后包含, 相等关系
    9.2 相等关系的处理（TODO）

10. 线段完成条件（新增）
    在有缺口的情况下，如果最终用线段封闭了缺口，那么前面的线段也就结束了